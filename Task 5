import pandas as pd
import os

# TODO: Replace or extend this list with the exact keywords from the assignment "References"
SECURITY_KEYWORDS = [
    "security",
    "vulnerability",
    "vulnerabilities",
    "patch",
    "exploit",
    "injection",
    "xss",
    "csrf",
    "sanitize",
    "sanitization",
    "leak",
    "data leak",
    "privilege",
    "overflow",
    "underflow",
    "unsafe",
    "malicious",
    "attack",
    "encryption",
    "authentication",
    "authorization",
    "ssl",
    "tls"
]


def detect_security(title: str, body: str) -> int:
    """
    Return 1 if any security-related keyword appears in the title or body,
    otherwise 0.
    """
    text = (str(title) + " " + str(body)).lower()
    for kw in SECURITY_KEYWORDS:
        if kw.lower() in text:
            return 1
    return 0


def main():
    os.makedirs("outputs", exist_ok=True)

    # Load Task-1 and Task-3 outputs (these contain everything we need)
    pr_info = pd.read_csv("outputs/task1_output.csv")   # from all_pull_request
    pr_type = pd.read_csv("outputs/task3_output.csv")   # from pr_task_type

    # Merge Task-1 and Task-3 on PR ID
    # Task-1: ID column
    # Task-3: PRID column
    merged = pr_info.merge(
        pr_type,
        left_on="ID",
        right_on="PRID",
        how="left"
    )

    # Compute SECURITY flag
    merged["SECURITY"] = merged.apply(
        lambda row: detect_security(row.get("TITLE", ""), row.get("BODYSTRING", "")),
        axis=1
    )

    # Build final Task-5 output
    final = merged[[
        "ID",          # PR ID
        "AGENTNAME",   # agent name (from Task-1)
        "PRTYPE",      # type (from Task-3)
        "CONFIDENCE",  # confidence (from Task-3)
        "SECURITY"     # computed boolean flag 1/0
    ]].rename(columns={
        "AGENTNAME": "AGENT",
        "PRTYPE": "TYPE"
    })

    final.to_csv("outputs/task5_output.csv", index=False)
    print("Task-5: outputs/task5_output.csv written successfully.")


if __name__ == "__main__":
    main()
